<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: store.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: store.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** @namespace */ 
(function(window){
	'use strict';

	/** 
	 * Creates a new client side storage object and will create an empty
	 * collection if no collection already exists.
	 * 
	 * @namespace
	 * @alias window.app.Storage
	 * @class
	 */
	function Storage (){
		this.adapter = new LocalStorage('DB_restaurants_S03');
		this.db = low(this.adapter);
		
		if(!this.db.has('restaurants').value()){
			this.db.defaults({restaurants:[]}).write();
		} 
	}

	/**
	 * Find and return an array of restaurants depending of the parameters of the request
	 *
	 * @param {object} query - The map's bounds
	 * @returns {array} Array of restaurants which fit the query
	 */
	Storage.prototype.find = function(query) {
		let restaurants = this.db.get('restaurants').value();
		let results = restaurants.filter(function(restaurant){
			if(restaurant.lat &lt; query.northLat &amp;&amp; restaurant.lat > query.southLat){
				if(restaurant.long &lt; query.northLng &amp;&amp; restaurant.long > query.southLng){
					return true;
				} 
			}
		})
		return results;
	}

	/**
	 * Save the given data into the DB.
	 * If there is no specified id, the data is an array of new restaurant(s).
	 * Otherwise, the id indicates which restaurant is to update
	 *
	 * @param {array|boolean} data - The data to save into the DB
	 * @param {function} callback - The function to fire after saving the data into the DB
	 * @param {string|number} [id] - The id of the restaurant to update
	 */
	Storage.prototype.save = function(data, callback, id){
		let restaurant;
		console.log(data)
		if(id){
			switch(typeof data){
				case "object":
					restaurant = this.db.get('restaurants')
										.find({id: id})
										.value();

					data.reviews.forEach(function(review){
						restaurant.ratings.unshift(review);
					})
					
					this.db.get('restaurants')
							.find({id: id})
							.assign({ratings: restaurant.ratings})
							.write();

					if(data.type == 'addReview'){
						this._average(restaurant);
					}

					break;
				case "boolean":
					this.db.get('restaurants')
							.find({id: id})
							.assign({picture: data})
							.write();
					break;
			}

			restaurant = this.db.get('restaurants')
								.find({id: id})
								.value();
			callback(restaurant)
			
		} else {
			const self = this;
			data.forEach(function(restaurant){
				// Check if the restaurant already exists in the DB
				if(self.db.get('restaurants').find({id: restaurant.id}).value()){
					return;
				}
				self.db.get('restaurants')
						.push(restaurant)
						.write();
			})
			callback();
		}
	}

	/**
	 * Calculate the average ratings of a restaurant
	 *
	 * @param {object} - restaurant - The restaurant
	 */
	Storage.prototype._average = function(restaurant){
		console.log(restaurant)
		let avg = ((restaurant.avg * restaurant.user_total) + restaurant.ratings[0].stars) / (restaurant.user_total + 1);
		console.log(restaurant)
		console.log(avg)
		this.db.get('restaurants')
				.find({id: restaurant.id})
				.assign({avg: avg})
				.assign({user_total: ++restaurant.user_total})
				.write()
	}

	window.app = window.app || {};
	window.app.Storage = Storage;

})(window);</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="window.App.html">App</a></li><li><a href="window.app.Controller.html">Controller</a></li><li><a href="window.app.Map.html">Map</a></li><li><a href="window.app.Model.html">Model</a></li><li><a href="window.app.Slider.html">Slider</a></li><li><a href="window.app.Storage.html">Storage</a></li><li><a href="window.app.Template.html">Template</a></li><li><a href="window.app.View.html">View</a></li></ul><h3>Global</h3><ul><li><a href="global.html#eraseCookie">eraseCookie</a></li><li><a href="global.html#getCookie">getCookie</a></li><li><a href="global.html#setCookie">setCookie</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Mar 19 2019 11:22:09 GMT+0100 (GMT+01:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
